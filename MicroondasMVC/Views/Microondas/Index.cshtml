@model MicroondasMVC.Models.Microondas

<h1>Micro-ondas Digital</h1>

<div class="container" style="display: flex; gap: 20px; flex-wrap: wrap;">
    
    <!-- LADO ESQUERDO: Controles Manuais -->
    <div style="border: 1px solid #ccc; padding: 20px; border-radius: 10px; max-width: 600px; flex: 1;">
        
        <form asp-action="Iniciar" method="post" style="display: inline-block;">
            <div style="margin-bottom: 10px;">
                <label>Tempo (segundos):</label>
                <input type="number" name="tempoSegundos" 
                       min="1" max="120" 
                       value="@(Model.Ligado || Model.Pausado ? Model.TempoRestante : (Model.TempoSegundos == 0 ? "" : Model.TempoSegundos))" 
                       @(Model.Ligado || Model.Pausado ? "readonly" : "") />
                <small class="text-muted d-block">Máx manual: 120s</small>
            </div>

            <div style="margin-bottom: 10px;">
                <label>Potência (1 a 10):</label>
                <input type="number" name="potencia" 
                       min="1" max="10" 
                       value="@(Model.Potencia == 0 ? "" : Model.Potencia)" 
                       @(Model.Ligado || Model.Pausado ? "readonly" : "") />
            </div>

            <button type="submit" class="btn btn-success" @(Model.ProgramaAtivo != null && Model.Ligado ? "disabled" : "")>Iniciar / +30s</button>
        </form>

        <form asp-action="PausarCancelar" method="post" style="display: inline-block; margin-left: 10px;">
            <button type="submit" class="btn btn-warning">
                Pausar / Cancelar
            </button>
        </form>

        <hr />

        @if (!string.IsNullOrWhiteSpace(Model.MsgStatus))
        {
            <div style="background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>Status:</strong> @Model.MsgStatus
            </div>
        }

        <h3 style="margin-top: 20px;">Visor:</h3>
        <div style="background-color: #000; color: #0f0; padding: 15px; font-family: monospace; font-size: 20px; min-height: 100px; border-radius: 5px; position: relative;">
            
            <div id="timerDisplay" style="position: absolute; top: 10px; right: 15px; color: #fff;">
                @{
                    string displayInicial = "---";
                    if (Model.Ligado || Model.Pausado)
                    {
                         int m = Model.TempoRestante / 60;
                         int s = Model.TempoRestante % 60;
                         displayInicial = m > 0 ? $"{m}:{s:00}" : $"{s}s";
                    }
                }
                @displayInicial
            </div>

            <div id="processamento" style="white-space: pre-wrap; word-break: break-all; margin-right: 50px;"></div>
        </div>
    </div>

    <!-- LADO DIREITO: Lista de Programas -->
    <div style="border: 1px solid #007bff; padding: 20px; border-radius: 10px; min-width: 300px; background-color: #f8f9fa;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 style="color: #007bff; margin: 0;">Programas</h4>
            <a href="/Microondas/Cadastro" class="btn btn-sm btn-primary">+ Novo</a>
        </div>
        
        <p><small>Selecione um alimento:</small></p>
        
        <div class="list-group" style="max-height: 500px; overflow-y: auto;">
            @foreach (var prog in MicroondasMVC.Models.Microondas.TodosProgramas)
            {
                <form asp-action="IniciarPrograma" method="post" style="margin-bottom: 5px;">
                    <input type="hidden" name="idPrograma" value="@prog.Id" />
                    
                    <button type="submit" class="list-group-item list-group-item-action" 
                            style="cursor: pointer;"
                            @(Model.Ligado || Model.Pausado ? "disabled" : "")>
                        
                        <div class="d-flex w-100 justify-content-between">
                            <!-- Estilo itálico se for customizado -->
                            <h5 class="mb-1" style="@(prog.EhCustomizado ? "font-style: italic; color: #6f42c1;" : "")">
                                @prog.Nome
                            </h5>
                            <small>@prog.Tempo s</small>
                        </div>
                        
                        <p class="mb-1" style="@(prog.EhCustomizado ? "font-style: italic;" : "")">
                            @prog.Alimento
                        </p>
                        
                        <small>Potência: @prog.Potencia | Char: '@prog.CaractereAquecimento'</small>
                    </button>
                </form>
            }
        </div>
    </div>
</div>

<script>
    let tempoRestante = @Model.TempoRestante;
    let potencia = @Model.Potencia;
    let estaLigado = @Model.Ligado.ToString().ToLower();
    let estaPausado = @Model.Pausado.ToString().ToLower();
    
    // Garante que o caractere seja interpretado corretamente pelo JS
    let caractereAquecimento = "@Html.Raw(Model.CaractereAtual)";

    if (estaLigado && tempoRestante > 0) {
        iniciarAnimacao(tempoRestante, potencia, caractereAquecimento);
    }
    else if (estaPausado && tempoRestante > 0) {
        atualizarVisor(tempoRestante, potencia, caractereAquecimento);
        document.getElementById("processamento").style.opacity = "0.5";
    }

    function formatarTempoJs(segundos) {
        if (segundos >= 60) {
            let m = Math.floor(segundos / 60);
            let s = segundos % 60;
            let sFormatado = s < 10 ? "0" + s : s; 
            return m + ":" + sFormatado;
        }
        return segundos + "s";
    }

    function atualizarVisor(segundos, potencia, char) {
        let linha = "";
        for (let i = 0; i < segundos; i++) {
            linha += char.repeat(potencia) + " ";
        }
        document.getElementById("processamento").textContent = linha;
        document.getElementById("timerDisplay").textContent = formatarTempoJs(segundos);
    }

    function iniciarAnimacao(tempo, potencia, char) {
        let contador = tempo;
        atualizarVisor(contador, potencia, char);

        let intervalo = setInterval(() => {
            contador--;
            if (contador > 0) {
                atualizarVisor(contador, potencia, char);
            } else {
                clearInterval(intervalo);
                document.getElementById("timerDisplay").textContent = "0s";
                document.getElementById("processamento").textContent = "Aquecimento concluído";
                notificarFimAoServidor();
            }
        }, 1000);
    }

    function notificarFimAoServidor() {
        fetch('/Microondas/Desligar', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    setTimeout(() => { window.location.href = window.location.href; }, 2000);
                }
            });
    }
</script>