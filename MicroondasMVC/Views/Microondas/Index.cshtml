@model MicroondasMVC.Models.Microondas

<h1>Micro-ondas</h1>

<div style="border: 1px solid #ccc; padding: 20px; border-radius: 10px; max-width: 600px;">

    <form asp-action="Iniciar" method="post" style="display: inline-block;">
        <div style="margin-bottom: 10px;">
            <label>Tempo (segundos):</label>
            <input type="number" name="tempoSegundos" 
                   min="1" max="120" 
                   value="@(Model.Ligado || Model.Pausado ? Model.TempoRestante : (Model.TempoSegundos == 0 ? "" : Model.TempoSegundos))" 
                   @(Model.Ligado || Model.Pausado ? "readonly" : "") />
        </div>

        <div style="margin-bottom: 10px;">
            <label>Potência (1 a 10):</label>
            <input type="number" name="potencia" 
                   min="1" max="10" 
                   value="@(Model.Potencia == 0 ? "" : Model.Potencia)" 
                   @(Model.Ligado || Model.Pausado ? "readonly" : "") />
        </div>

        <button type="submit" class="btn btn-success">
            @if(Model.Ligado) { <text>Acrescentar +30s</text> }
            else if(Model.Pausado) { <text>Retomar</text> }
            else { <text>Iniciar Aquecimento</text> }
        </button>
    </form>

    <form asp-action="PausarCancelar" method="post" style="display: inline-block; margin-left: 10px;">
        <button type="submit" class="btn btn-warning">
            Pausar / Cancelar
        </button>
    </form>

    <hr />

    @if (!string.IsNullOrWhiteSpace(Model.MsgStatus))
    {
        <div style="background-color: #e9ecef; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong>Status:</strong> @Model.MsgStatus
        </div>
    }

    <h3 style="margin-top: 20px;">Visor:</h3>
    <div style="background-color: #000; color: #0f0; padding: 15px; font-family: monospace; font-size: 20px; min-height: 100px; border-radius: 5px; position: relative;">
        
        <div id="timerDisplay" style="position: absolute; top: 10px; right: 15px; color: #fff;">
            @{
                string displayInicial = "---";
                // Mostra tempo se estiver Ligado OU Pausado
                if (Model.Ligado || Model.Pausado)
                {
                     int m = Model.TempoRestante / 60;
                     int s = Model.TempoRestante % 60;
                     displayInicial = m > 0 ? $"{m}:{s:00}" : $"{s}s";
                }
            }
            @displayInicial
        </div>

        <div id="processamento" style="white-space: pre-wrap; word-break: break-all; margin-right: 50px;"></div>
    </div>

</div>

<script>
    let tempoRestante = @Model.TempoRestante;
    let potencia = @Model.Potencia;
    
    // Convertendo boleanos C# para JS
    let estaLigado = @Model.Ligado.ToString().ToLower();
    let estaPausado = @Model.Pausado.ToString().ToLower();

    // 1. Se estiver LIGADO: Inicia a animação regressiva
    if (estaLigado && tempoRestante > 0) {
        iniciarAnimacao(tempoRestante, potencia);
    }
    // 2. Se estiver PAUSADO: Apenas desenha o estado atual estático
    else if (estaPausado && tempoRestante > 0) {
        atualizarVisor(tempoRestante, potencia);
        document.getElementById("processamento").style.opacity = "0.5"; // Efeito visual de pausa (opcional)
    }

    function formatarTempoJs(segundos) {
        if (segundos >= 60) {
            let m = Math.floor(segundos / 60);
            let s = segundos % 60;
            let sFormatado = s < 10 ? "0" + s : s; 
            return m + ":" + sFormatado;
        }
        return segundos + "s";
    }

    function atualizarVisor(segundos, potencia) {
        let linha = "";
        for (let i = 0; i < segundos; i++) {
            linha += ".".repeat(potencia) + " ";
        }
        
        document.getElementById("processamento").textContent = linha;
        document.getElementById("timerDisplay").textContent = formatarTempoJs(segundos);
    }

    function iniciarAnimacao(tempo, potencia) {
        let contador = tempo;
        atualizarVisor(contador, potencia);

        let intervalo = setInterval(() => {
            contador--;

            if (contador > 0) {
                atualizarVisor(contador, potencia);
            } else {
                clearInterval(intervalo);
                
                document.getElementById("timerDisplay").textContent = "0s";
                document.getElementById("processamento").textContent = "Aquecimento concluído";

                notificarFimAoServidor();
            }
        }, 1000);
    }

    function notificarFimAoServidor() {
        fetch('/Microondas/Desligar', { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    setTimeout(() => { window.location.href = window.location.href; }, 2000);
                }
            });
    }
</script>